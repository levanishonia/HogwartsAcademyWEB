<!DOCTYPE html>
<html lang="ka">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>рЃњрЃарЃўрЃцрЃўрЃюрЃЊрЃЮрЃарЃўрЃА рЃАрЃљрЃўрЃЊрЃБрЃЏрЃџрЃЮ рЃЮрЃЌрЃљрЃ«рЃў</title>
    <link rel="stylesheet" href="Styles/style.css"> 
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
</head>
<body class="gryffindor-bg">
    
    <main class="house-page">
        <section class="house-content" data-aos="zoom-in">
            <h2>рЃЏрЃЮрЃњрЃћрЃАрЃљрЃџрЃЏрЃћрЃЉрЃўрЃЌ, рЃЏрЃљрЃЏрЃљрЃфрЃћрЃЉрЃЮ рЃњрЃарЃўрЃцрЃўрЃюрЃЊрЃЮрЃарЃћрЃџрЃћрЃЉрЃЮ!</h2>
            <p>рЃЏрЃ«рЃЮрЃџрЃЮрЃЊ рЃДрЃЋрЃћрЃџрЃљрЃќрЃћ рЃЏрЃљрЃЏрЃљрЃфрЃў рЃњрЃБрЃџрЃћрЃЉрЃў рЃљрЃдрЃгрЃћрЃЋрЃћрЃю рЃљрЃЏ рЃљрЃЊрЃњрЃўрЃџрЃљрЃЏрЃЊрЃћ.</p>
            
            <div class="news-section">
                <h3>­ЪЈа рЃњрЃарЃўрЃцрЃўрЃюрЃЊрЃЮрЃарЃўрЃА рЃАрЃўрЃљрЃ«рЃџрЃћрЃћрЃЉрЃў (рЃљрЃЊрЃЏрЃўрЃюрЃўрЃАрЃбрЃарЃљрЃбрЃЮрЃарЃўрЃАрЃЌрЃЋрЃўрЃА)</h3>
                
                <form id="newsForm" style="margin-bottom: 20px;">
                    <input type="text" id="newsTitle" placeholder="рЃАрЃљрЃЌрЃљрЃБрЃарЃў" style="width: 100%; padding: 8px; margin-bottom: 10px;">
                    <textarea id="newsContent" placeholder="рЃАрЃўрЃљрЃ«рЃџрЃўрЃА рЃбрЃћрЃЦрЃАрЃбрЃў" rows="3" style="width: 100%; padding: 8px;"></textarea>
                    <button type="submit" style="padding: 10px; background-color: #740001; color: #FFD700; border: none; cursor: pointer;">рЃАрЃўрЃљрЃ«рЃџрЃўрЃА рЃЊрЃљрЃЏрЃљрЃбрЃћрЃЉрЃљ</button>
                </form>

                <div id="newsFeed">
                    <div class="news-item">
                        <h4>­ЪЈ░ рЃЎрЃЋрЃўрЃарЃўрЃА рЃерЃћрЃЎрЃарЃћрЃЉрЃљ:</h4>
                        <p>рЃЏрЃЮрЃЏрЃЊрЃћрЃЋрЃюрЃЮ рЃерЃљрЃЉрЃљрЃЌрЃА, рЃАрЃљрЃдрЃљрЃЏрЃЮрЃА 7 рЃАрЃљрЃљрЃЌрЃќрЃћ, рЃЊрЃўрЃЊ рЃЊрЃљрЃарЃЉрЃљрЃќрЃерЃў! рЃљрЃа рЃЊрЃљрЃњрЃљрЃЋрЃўрЃгрЃДрЃЊрЃћрЃЌ рЃАрЃљрЃўрЃЊрЃБрЃЏрЃџрЃЮ рЃърЃљрЃарЃЮрЃџрЃў.</p>
                        <small>рЃљрЃбрЃЋрЃўрЃарЃЌрЃљ: рЃърЃарЃЮрЃц. рЃЏрЃљрЃЎрЃњрЃЮрЃюрЃљрЃњрЃћрЃџрЃЏрЃљ</small>
                    </div>
                </div>
            </div>

            <div class="chat-section">
                <h3>­Ъњг рЃњрЃарЃўрЃцрЃўрЃюрЃЊрЃЮрЃарЃўрЃА рЃЏрЃўрЃЏрЃЮрЃгрЃћрЃарЃљ (рЃџрЃљрЃўрЃЋ рЃЕрЃљрЃбрЃў)</h3>
                <div class="chat-box" id="chatBox">
                    <div class="chat-message other"><span>рЃърЃарЃЮрЃц. рЃЏрЃљрЃЎрЃњрЃЮрЃюрЃљрЃњрЃћрЃџрЃў: рЃЏрЃерЃЋрЃћрЃюрЃўрЃћрЃарЃўрЃљ, рЃарЃЮрЃЏ рЃћрЃА рЃЮрЃЌрЃљрЃ«рЃў рЃўрЃърЃЮрЃЋрЃћрЃЌ!</span></div>
                </div>
                
                <input type="text" id="chatInput" placeholder="рЃерЃћрЃўрЃДрЃЋрЃљрЃюрЃћрЃЌ рЃерЃћрЃбрЃДрЃЮрЃЉрЃўрЃюрЃћрЃЉрЃљ..." style="width: 80%; padding: 8px;">
                <button onclick="sendMessage()" style="width: 18%; padding: 8px; background-color: #740001; color: #FFD700; border: none; cursor: pointer;">рЃњрЃљрЃњрЃќрЃљрЃЋрЃюрЃљ</button>
            </div>
            
            <a href="index.html" style="color: #FFD700; font-weight: bold; display: block; margin-top: 30px;">рЃЊрЃљрЃЉрЃарЃБрЃюрЃЊрЃў рЃљрЃЎрЃљрЃЊрЃћрЃЏрЃўрЃљрЃерЃў</a>
        </section>
    </main>

    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
      AOS.init({ duration: 1000, once: true });
    </script>
    <button id="backToTopBtn" class="back-to-top" aria-label="рЃљрЃАрЃЦрЃарЃЮрЃџрЃЋрЃљ рЃњрЃЋрЃћрЃарЃЊрЃўрЃА рЃЌрЃљрЃЋрЃќрЃћ">&#9650;</button>
    <script src="Scripts/styles/backToTop.js"></script> 
    <script src="/socket.io/socket.io.js"></script> 
    
    <script>
    // =========================================================
    // РюЁ 1. рЃфрЃЋрЃџрЃљрЃЊрЃћрЃЉрЃўрЃА рЃўрЃюрЃўрЃфрЃўрЃљрЃџрЃўрЃќрЃљрЃфрЃўрЃљ
    // =========================================================
    const socket = io(); 
    const chatBox = document.getElementById('chatBox');
    const newsFeed = document.getElementById('newsFeed');
    
    // рЃЊрЃарЃЮрЃћрЃЉрЃўрЃЌрЃў рЃЏрЃЮрЃЏрЃ«рЃЏрЃљрЃарЃћрЃЉрЃџрЃўрЃА рЃАрЃљрЃ«рЃћрЃџрЃў
    const userName = 'рЃњрЃарЃўрЃцрЃўрЃюрЃЊрЃЮрЃарЃћрЃџрЃў_' + Math.floor(Math.random() * 100);

    // =========================================================
    // РюЁ 2. рЃАрЃўрЃљрЃ«рЃџрЃћрЃћрЃЉрЃўрЃА рЃЏрЃљрЃарЃЌрЃЋрЃљ (POST, FETCH, DELETE)
    // =========================================================

    // рЃцрЃБрЃюрЃЦрЃфрЃўрЃљ: рЃАрЃўрЃљрЃ«рЃџрЃћрЃћрЃЉрЃўрЃА HTML-рЃерЃў рЃЊрЃљрЃЏрЃљрЃбрЃћрЃЉрЃљ (рЃгрЃљрЃерЃџрЃўрЃА рЃдрЃўрЃџрЃљрЃЎрЃўрЃА рЃЕрЃљрЃЌрЃЋрЃџрЃўрЃЌ)
    function addNewsToFeed(post) {
        // рЃЌрЃБ рЃърЃЮрЃАрЃбрЃў рЃБрЃЎрЃЋрЃћ рЃљрЃарЃАрЃћрЃЉрЃЮрЃЉрЃА (Socket.IO-рЃА рЃњрЃљрЃЮрЃарЃЏрЃљрЃњрЃћрЃЉрЃўрЃА рЃЌрЃљрЃЋрЃўрЃЊрЃљрЃю рЃљрЃАрЃљрЃфрЃўрЃџрЃћрЃЉрЃџрЃљрЃЊ)
        if (document.getElementById(`news-post-${post.id}`)) {
            return; 
        }

        const newPost = document.createElement('div');
        newPost.classList.add('news-item');
        newPost.id = `news-post-${post.id}`; // РюЁ рЃБрЃюрЃўрЃЎрЃљрЃџрЃБрЃарЃў ID рЃгрЃљрЃерЃџрЃўрЃАрЃЌрЃЋрЃўрЃА
        
        const formattedDate = new Date(post.timestamp).toLocaleDateString('ka-GE');

        newPost.innerHTML = `
            <h4>­ЪћЦ ${post.title}</h4>
            <p>${post.content}</p>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 5px;">
                <small>рЃљрЃбрЃЋрЃўрЃарЃЌрЃљ: ${post.user} | ${formattedDate}</small>
                <button class="delete-news-btn" 
                        data-post-id="${post.id}" 
                        style="background-color: #A00000; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 5px; font-size: 12px; transition: background-color 0.2s;"
                        onmouseover="this.style.backgroundColor='#740001';"
                        onmouseout="this.style.backgroundColor='#A00000';">
                    рЃгрЃљрЃерЃџрЃљ
                </button>
            </div>
        `;
        
        // рЃљрЃ«рЃљрЃџрЃў рЃърЃЮрЃАрЃбрЃў рЃЊрЃљрЃћрЃЏрЃљрЃбрЃЮрЃА рЃАрЃўрЃўрЃА рЃЌрЃљрЃЋрЃерЃў
        newsFeed.prepend(newPost); 
    }
    
    // рЃцрЃБрЃюрЃЦрЃфрЃўрЃљ: рЃАрЃўрЃљрЃ«рЃџрЃћрЃћрЃЉрЃўрЃА рЃАрЃћрЃарЃЋрЃћрЃарЃўрЃЊрЃљрЃю рЃгрЃљрЃЏрЃЮрЃдрЃћрЃЉрЃљ рЃњрЃЋрЃћрЃарЃЊрЃўрЃА рЃЕрЃљрЃбрЃЋрЃўрЃарЃЌрЃЋрЃўрЃАрЃљрЃА
    async function fetchInitialNews() {
        try {
            const response = await fetch('/api/news');
            const news = await response.json();
            
            // рЃгрЃљрЃерЃљрЃџрЃћрЃЌ рЃАрЃљрЃгрЃДрЃўрЃАрЃў HTML-рЃўрЃА рЃърЃЮрЃАрЃбрЃў
            newsFeed.innerHTML = ''; 

            // рЃЊрЃљрЃљрЃЏрЃљрЃбрЃћрЃЌ рЃДрЃЋрЃћрЃџрЃљ рЃерЃћрЃюрЃљрЃ«рЃБрЃџрЃў рЃАрЃўрЃљрЃ«рЃџрЃћ
            news.forEach(post => addNewsToFeed(post));

        } catch (error) {
            console.error('рЃАрЃўрЃљрЃ«рЃџрЃћрЃћрЃЉрЃўрЃА рЃЕрЃљрЃбрЃЋрЃўрЃарЃЌрЃЋрЃўрЃА рЃерЃћрЃфрЃЊрЃЮрЃЏрЃљ:', error);
            newsFeed.innerHTML = '<p style="color:#FFD700;">рЃАрЃўрЃљрЃ«рЃџрЃћрЃћрЃЉрЃўрЃА рЃЕрЃљрЃбрЃЋрЃўрЃарЃЌрЃЋрЃљ рЃЋрЃћрЃа рЃЏрЃЮрЃ«рЃћрЃарЃ«рЃЊрЃљ.</p>';
        }
    }

    // рЃцрЃБрЃюрЃЦрЃфрЃўрЃљ: рЃАрЃћрЃарЃЋрЃћрЃарЃќрЃћ рЃгрЃљрЃерЃџрЃўрЃА рЃЏрЃЮрЃЌрЃ«рЃЮрЃЋрЃюрЃўрЃА рЃњрЃљрЃАрЃљрЃњрЃќрЃљрЃЋрЃюрЃљрЃЊ
    async function deleteNewsPost(postId) {
        if (!confirm('рЃюрЃљрЃЏрЃЊрЃЋрЃўрЃџрЃљрЃЊ рЃњрЃАрЃБрЃарЃЌ рЃљрЃЏ рЃАрЃўрЃљрЃ«рЃџрЃўрЃА рЃгрЃљрЃерЃџрЃљ?')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/news/${postId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                // рЃџрЃЮрЃЎрЃљрЃџрЃБрЃарЃљрЃЊ рЃгрЃљрЃерЃџрЃљ (Socket.IO-рЃЌрЃў рЃњрЃљрЃюрЃљрЃ«рЃџрЃћрЃЉрЃўрЃА рЃЌрЃљрЃЋрЃўрЃЊрЃљрЃю рЃљрЃАрЃљрЃфрЃўрЃџрЃћрЃЉрЃџрЃљрЃЊ)
                document.getElementById(`news-post-${postId}`).remove();
            } else {
                const error = await response.json();
                alert('рЃгрЃљрЃерЃџрЃўрЃА рЃерЃћрЃфрЃЊрЃЮрЃЏрЃљ: ' + error.message);
            }
        } catch (error) {
            console.error('Error deleting post:', error);
            alert('рЃерЃћрЃфрЃЊрЃЮрЃЏрЃљ рЃАрЃћрЃарЃЋрЃћрЃарЃЌрЃљрЃю рЃЎрЃљрЃЋрЃерЃўрЃарЃўрЃАрЃљрЃА.');
        }
    }

    // рЃЏрЃЮрЃЋрЃџрЃћрЃюрЃљ: рЃцрЃЮрЃарЃЏрЃўрЃА рЃњрЃљрЃњрЃќрЃљрЃЋрЃюрЃљ (рЃАрЃўрЃљрЃ«рЃџрЃўрЃА рЃЊрЃљрЃЏрЃљрЃбрЃћрЃЉрЃљ)
    document.getElementById('newsForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const title = document.getElementById('newsTitle').value;
        const content = document.getElementById('newsContent').value;

        if (!title || !content) {
            alert('рЃњрЃЌрЃ«рЃЮрЃЋрЃЌ, рЃерЃћрЃљрЃЋрЃАрЃЮрЃЌ рЃарЃЮрЃњрЃЮрЃарЃф рЃАрЃљрЃЌрЃљрЃБрЃарЃў, рЃўрЃАрЃћ рЃбрЃћрЃЦрЃАрЃбрЃў.');
            return;
        }

        const response = await fetch('/api/news', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                title, 
                content, 
                user: "рЃљрЃЊрЃЏрЃўрЃюрЃў (рЃЊрЃарЃЮрЃћрЃЉрЃўрЃЌ)"
            })
        });

        const result = await response.json();

        if (result.success) {
            document.getElementById('newsTitle').value = '';
            document.getElementById('newsContent').value = '';
            // рЃљрЃа рЃњрЃЋрЃГрЃўрЃарЃЊрЃћрЃЉрЃљ addNewsToFeed рЃљрЃЦ, рЃарЃљрЃЊрЃњрЃљрЃю Socket.IO рЃњрЃљрЃЏрЃЮрЃљрЃњрЃќрЃљрЃЋрЃюрЃўрЃА рЃЏрЃљрЃА
            alert('рЃАрЃўрЃљрЃ«рЃџрЃћ рЃгрЃљрЃарЃЏрЃљрЃбрЃћрЃЉрЃўрЃЌ рЃЊрЃљрЃћрЃЏрЃљрЃбрЃљ!');
        } else {
            alert('рЃерЃћрЃфрЃЊрЃЮрЃЏрЃљ рЃАрЃўрЃљрЃ«рЃџрЃўрЃА рЃЊрЃљрЃЏрЃљрЃбрЃћрЃЉрЃўрЃАрЃљрЃА: ' + result.message);
        }
    });

    // Socket.IO: рЃЏрЃЮрЃБрЃАрЃЏрЃўрЃюрЃћрЃЌ рЃљрЃ«рЃљрЃџ рЃАрЃўрЃљрЃ«рЃџрЃћрЃћрЃЉрЃА
    socket.on('newNewsPost', function(post) {
        addNewsToFeed(post);
    });

    // Socket.IO: рЃЏрЃЮрЃБрЃАрЃЏрЃўрЃюрЃћрЃЌ рЃгрЃљрЃерЃџрЃўрЃА рЃћрЃЋрЃћрЃюрЃбрЃА рЃАрЃ«рЃЋрЃљ рЃЎрЃџрЃўрЃћрЃюрЃбрЃћрЃЉрЃўрЃЊрЃљрЃю
    socket.on('deleteNewsPost', function(data) {
        const element = document.getElementById(`news-post-${data.id}`);
        if (element) {
            element.remove();
        }
    });

    // РюЁ рЃљрЃ«рЃљрЃџрЃў: рЃдрЃўрЃџрЃљрЃЎрЃћрЃЉрЃќрЃћ рЃЊрЃљрЃГрЃћрЃарЃўрЃА рЃЏрЃљрЃарЃЌрЃЋрЃљ (рЃгрЃљрЃерЃџрЃљ рЃдрЃўрЃџрЃљрЃЎрЃўрЃАрЃЌрЃЋрЃўрЃА)
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('delete-news-btn')) {
            const postId = e.target.getAttribute('data-post-id');
            deleteNewsPost(postId);
        }
    });
    
    // =========================================================
    // РюЁ 3. рЃЕрЃљрЃбрЃўрЃА рЃџрЃЮрЃњрЃўрЃЎрЃљ (Socket.IO)
    // =========================================================

    function sendMessage() {
        const input = document.getElementById('chatInput');
        const messageText = input.value.trim();
        
        if (messageText) {
            const messageObject = {
                user: userName,
                text: messageText,
                timestamp: new Date().toLocaleTimeString('ka-GE')
            };
            
            socket.emit('chatMessage', messageObject); 
            input.value = '';
        }
    }
    
    socket.on('chatMessage', function(msg) {
        const isMe = msg.user === userName;
        
        const messageElement = document.createElement('div');
        messageElement.classList.add('chat-message', isMe ? 'me' : 'other'); 
        
        messageElement.innerHTML = `
            <div style="display:flex; flex-direction:column; align-items: ${isMe ? 'flex-end' : 'flex-start'};">
                ${!isMe ? `<small style="font-size:12px; color:#FFD700; font-weight:bold; margin-bottom: 3px;">${msg.user}</small>` : ''}
                <span>${msg.text}</span>
                <small style="font-size:10px; opacity:0.6; margin-top:2px;">${msg.timestamp}</small>
            </div>
        `;
        
        chatBox.appendChild(messageElement);
        chatBox.scrollTop = chatBox.scrollHeight;
    });

    document.getElementById('chatInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    // РюЁ 4. рЃњрЃЋрЃћрЃарЃЊрЃўрЃА рЃЕрЃљрЃбрЃЋрЃўрЃарЃЌрЃЋрЃўрЃАрЃљрЃА рЃАрЃўрЃљрЃ«рЃџрЃћрЃћрЃЉрЃўрЃА рЃгрЃљрЃЏрЃЮрЃдрЃћрЃЉрЃљ
    document.addEventListener('DOMContentLoaded', fetchInitialNews);
</script>
</body>
</html>