// server.js - Node.js рЃАрЃћрЃарЃЋрЃћрЃарЃў Express-рЃўрЃЌ рЃЊрЃљ Socket.IO-рЃЌрЃў

const express = require('express');
const http = require('http');
const socketIo = require('socket.io');
// РюЁ Node.js-рЃўрЃА рЃцрЃљрЃўрЃџрЃБрЃарЃў рЃАрЃўрЃАрЃбрЃћрЃЏрЃўрЃА рЃЏрЃЮрЃЊрЃБрЃџрЃў рЃЏрЃЮрЃюрЃљрЃфрЃћрЃЏрЃЌрЃљ рЃерЃћрЃАрЃљрЃюрЃљрЃ«рЃљрЃЊ
const fs = require('fs');
const path = require('path');

const app = express();
const server = http.createServer(app);

// ­ЪћЉ рЃфрЃЋрЃџрЃўрЃџрЃћрЃЉрЃљ: Socket.IO-рЃА рЃўрЃюрЃўрЃфрЃўрЃљрЃџрЃўрЃќрЃљрЃфрЃўрЃљ CORS-рЃўрЃЌ, рЃарЃљрЃф рЃљрЃБрЃфрЃўрЃџрЃћрЃЉрЃћрЃџрЃўрЃљ, рЃарЃЮрЃЏ рЃЎрЃљрЃЋрЃерЃўрЃарЃў рЃЊрЃљрЃЏрЃДрЃљрЃарЃЊрЃћрЃА
// рЃЌрЃБ рЃАрЃљрЃўрЃбрЃў рЃЊрЃљ рЃАрЃћрЃарЃЋрЃћрЃарЃў рЃАрЃ«рЃЋрЃљрЃЊрЃљрЃАрЃ«рЃЋрЃљ рЃЊрЃЮрЃЏрЃћрЃюрЃќрЃћрЃљ (рЃарЃљрЃф рЃ░рЃЮрЃАрЃбрЃўрЃюрЃњрЃќрЃћ рЃ«рЃерЃўрЃарЃљрЃЊ рЃ«рЃЊрЃћрЃЉрЃљ).
// рЃБрЃАрЃљрЃцрЃарЃЌрЃ«рЃЮрЃћрЃЉрЃўрЃА рЃњрЃљрЃАрЃљрЃБрЃЏрЃ»рЃЮрЃЉрЃћрЃАрЃћрЃЉрЃџрЃљрЃЊ, origin: "*" рЃЕрЃљрЃљрЃюрЃљрЃфрЃЋрЃџрЃћрЃЌ рЃЌрЃЦрЃЋрЃћрЃюрЃў рЃЋрЃћрЃЉ-рЃњрЃЋрЃћрЃарЃЊрЃўрЃА рЃЏрЃўрЃАрЃљрЃЏрЃљрЃарЃЌрЃўрЃЌ (рЃЏрЃљрЃњрЃљрЃџрЃўрЃЌрЃљрЃЊ: https://www.yourdomain.com).
const io = socketIo(server, {
    cors: {
        origin: "*", 
        methods: ["GET", "POST"]
    }
}); 

const PORT = 3000;
const NEWS_FILE = path.join(__dirname, 'gryffindor_news.json'); // РюЁ рЃцрЃљрЃўрЃџрЃў рЃЏрЃЮрЃюрЃљрЃфрЃћрЃЏрЃћрЃЉрЃўрЃА рЃерЃћрЃАрЃљрЃюрЃљрЃ«рЃљрЃЊ

// РюЁ Express-рЃўрЃА рЃерЃБрЃљрЃџрЃћрЃЊрЃБрЃарЃў рЃърЃарЃЮрЃњрЃарЃљрЃЏрЃљ (Middleware) JSON-рЃўрЃА рЃњрЃљрЃАрЃљрЃљрЃюрЃљрЃџрЃўрЃќрЃћрЃЉрЃџрЃљрЃЊ
app.use(express.json());

// 1. рЃАрЃбрЃљрЃбрЃўрЃЎрЃБрЃарЃў рЃцрЃљрЃўрЃџрЃћрЃЉрЃўрЃА рЃАрЃћрЃарЃЋрЃўрЃарЃћрЃЉрЃљ (HOGWARTS/ рЃАрЃљрЃЦрЃљрЃдрЃљрЃџрЃЊрЃћ)
app.use(express.static(__dirname)); 

// =========================================================
// РюЁ рЃЏрЃЮрЃюрЃљрЃфрЃћрЃЏрЃЌрЃљ рЃЏрЃљрЃарЃЌрЃЋрЃўрЃА рЃцрЃБрЃюрЃЦрЃфрЃўрЃћрЃЉрЃў (рЃцрЃљрЃўрЃџрЃБрЃарЃў рЃАрЃўрЃАрЃбрЃћрЃЏрЃўрЃА рЃњрЃљрЃЏрЃЮрЃДрЃћрЃюрЃћрЃЉрЃўрЃЌ)
// =========================================================

// рЃАрЃўрЃљрЃ«рЃџрЃћрЃћрЃЉрЃўрЃА рЃгрЃљрЃЎрЃўрЃЌрЃ«рЃЋрЃљ рЃцрЃљрЃўрЃџрЃўрЃЊрЃљрЃю
function readNews() {
    try {
        if (!fs.existsSync(NEWS_FILE)) {
            // рЃЌрЃБ рЃцрЃљрЃўрЃџрЃў рЃљрЃа рЃљрЃарЃАрЃћрЃЉрЃЮрЃЉрЃА, рЃерЃћрЃЦрЃЏрЃћрЃюрЃў рЃфрЃљрЃарЃўрЃћрЃџрЃў рЃЏрЃљрЃАрЃўрЃЋрЃў
            fs.writeFileSync(NEWS_FILE, JSON.stringify([]));
            return [];
        }
        const data = fs.readFileSync(NEWS_FILE, 'utf8');
        return JSON.parse(data);
    } catch (error) {
        console.error('Error reading news file:', error);
        return [];
    }
}

// рЃАрЃўрЃљрЃ«рЃџрЃћрЃћрЃЉрЃўрЃА рЃЕрЃљрЃгрЃћрЃарЃљ рЃцрЃљрЃўрЃџрЃерЃў
function writeNews(news) {
    try {
        fs.writeFileSync(NEWS_FILE, JSON.stringify(news, null, 2));
    } catch (error) {
        console.error('Error writing news file:', error);
    }
}

// =========================================================
// РюЁ API рЃћрЃюрЃЊрЃърЃЮрЃўрЃюрЃбрЃћрЃЉрЃў рЃАрЃўрЃљрЃ«рЃџрЃћрЃћрЃЉрЃўрЃАрЃЌрЃЋрЃўрЃА
// =========================================================

// GET /api/news: рЃДрЃЋрЃћрЃџрЃљ рЃАрЃўрЃљрЃ«рЃџрЃўрЃА рЃЏрЃўрЃдрЃћрЃЉрЃљ
app.get('/api/news', (req, res) => {
    const news = readNews().reverse(); // рЃЉрЃЮрЃџрЃЮ рЃЊрЃљрЃЏрЃљрЃбрЃћрЃЉрЃБрЃџрЃў рЃърЃўрЃарЃЋрЃћрЃџрЃў рЃњрЃљрЃЏрЃЮрЃЕрЃюрЃЊрЃћрЃА
    res.json(news);
});

// POST /api/news: рЃАрЃўрЃљрЃ«рЃџрЃўрЃА рЃЊрЃљрЃЏрЃљрЃбрЃћрЃЉрЃљ
app.post('/api/news', (req, res) => {
    const { title, content, user } = req.body;
    
    // РюЁ рЃЏрЃљрЃарЃбрЃўрЃЋрЃў рЃЋрЃљрЃџрЃўрЃЊрЃљрЃфрЃўрЃљ
    if (!title || !content || !user) {
        return res.status(400).json({ success: false, message: 'рЃАрЃљрЃЌрЃљрЃБрЃарЃў рЃЊрЃљ рЃбрЃћрЃЦрЃАрЃбрЃў рЃљрЃБрЃфрЃўрЃџрЃћрЃЉрЃћрЃџрЃўрЃљ.' });
    }

    const news = readNews();
    const newId = Date.now().toString(); // рЃБрЃюрЃўрЃЎрЃљрЃџрЃБрЃарЃў ID рЃЊрЃарЃЮрЃўрЃА рЃЏрЃўрЃ«рЃћрЃЊрЃЋрЃўрЃЌ
    
    const newPost = {
        id: newId,
        title,
        content,
        user, // рЃЋрЃўрЃюрЃф рЃљрЃбрЃЋрЃўрЃарЃЌрЃљ
        timestamp: new Date().toISOString()
    };
    
    news.push(newPost);
    writeNews(news);
    
    // РюЁ рЃљрЃ«рЃљрЃџрЃў рЃАрЃўрЃљрЃ«рЃџрЃўрЃА рЃњрЃљрЃњрЃќрЃљрЃЋрЃюрЃљ рЃДрЃЋрЃћрЃџрЃљ рЃЎрЃџрЃўрЃћрЃюрЃбрЃќрЃћ Socket.IO-рЃА рЃњрЃљрЃЏрЃЮрЃДрЃћрЃюрЃћрЃЉрЃўрЃЌ
    io.to('gryffindor_chat').emit('newNewsPost', newPost);
    
    res.status(201).json({ success: true, post: newPost });
});
// ... (рЃљрЃарЃАрЃћрЃЉрЃБрЃџрЃў app.post('/api/news', ...) рЃЉрЃџрЃЮрЃЎрЃўрЃА рЃерЃћрЃЏрЃЊрЃћрЃњ) ...

// DELETE /api/news/:id: рЃАрЃўрЃљрЃ«рЃџрЃўрЃА рЃгрЃљрЃерЃџрЃљ
app.delete('/api/news/:id', (req, res) => {
    const postId = req.params.id;
    let news = readNews();
    
    const initialLength = news.length;
    
    // рЃњрЃљрЃцрЃўрЃџрЃбрЃЋрЃарЃљ: рЃЊрЃљрЃбрЃЮрЃЋрЃћрЃЌ рЃЏрЃ«рЃЮрЃџрЃЮрЃЊ рЃўрЃА рЃърЃЮрЃАрЃбрЃћрЃЉрЃў, рЃарЃЮрЃЏрЃћрЃџрЃЌрЃљ ID рЃљрЃа рЃћрЃЏрЃЌрЃ«рЃЋрЃћрЃЋрЃљ рЃгрЃљрЃАрЃљрЃерЃџрЃћрЃџ ID-рЃА
    news = news.filter(post => post.id !== postId);
    
    if (news.length < initialLength) {
        writeNews(news);
        
        // РюЁ Socket.IO-рЃЌрЃў рЃерЃћрЃбрЃДрЃЮрЃЉрЃўрЃюрЃћрЃЉрЃўрЃА рЃњрЃљрЃњрЃќрЃљрЃЋрЃюрЃљ рЃДрЃЋрЃћрЃџрЃљ рЃЎрЃџрЃўрЃћрЃюрЃбрЃќрЃћ, рЃарЃЮрЃЏ рЃърЃЮрЃАрЃбрЃў рЃгрЃљрЃўрЃерЃљрЃџрЃљ
        io.to('gryffindor_chat').emit('deleteNewsPost', { id: postId });
        
        return res.json({ success: true, message: `Post ${postId} deleted.` });
    } else {
        return res.status(404).json({ success: false, message: 'Post not found.' });
    }
});

// ... (Socket.IO рЃЎрЃљрЃЋрЃерЃўрЃарЃћрЃЉрЃўрЃА рЃџрЃЮрЃњрЃўрЃЎрЃљ) ...

// =========================================================
// 2. Socket.IO рЃЎрЃљрЃЋрЃерЃўрЃарЃћрЃЉрЃўрЃА рЃџрЃЮрЃњрЃўрЃЎрЃљ
// =========================================================

io.on('connection', (socket) => {
  console.log('РюЁ рЃљрЃ«рЃљрЃџрЃў рЃЏрЃЮрЃЏрЃ«рЃЏрЃљрЃарЃћрЃЉрЃћрЃџрЃў рЃерЃћрЃЏрЃЮрЃБрЃћрЃарЃЌрЃЊрЃљ рЃЕрЃљрЃбрЃА');
  
  const room = 'gryffindor_chat';
  socket.join(room);

  socket.on('chatMessage', (msg) => {
    io.to(room).emit('chatMessage', msg); 
  });

  socket.on('disconnect', () => {
    console.log('РЮї рЃЏрЃЮрЃЏрЃ«рЃЏрЃљрЃарЃћрЃЉрЃћрЃџрЃЏрЃљ рЃЊрЃљрЃбрЃЮрЃЋрЃљ рЃЕрЃљрЃЌрЃў');
  });
});

// 3. рЃАрЃћрЃарЃЋрЃћрЃарЃўрЃА рЃњрЃљрЃерЃЋрЃћрЃЉрЃљ
server.listen(PORT, () => {
  console.log(`­Ъџђ рЃАрЃћрЃарЃЋрЃћрЃарЃў рЃЏрЃБрЃерЃљрЃЮрЃЉрЃА рЃърЃЮрЃарЃбрЃќрЃћ ${PORT}`);
});

